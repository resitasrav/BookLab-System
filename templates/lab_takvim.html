{% extends 'base.html' %}
{% load static %}

{% block icerik %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>

<style>
    :root {
        --btu-blue: #003366;
        --btu-accent: #00a8cc;
    }

    /* Arka Plan Artƒ± Sembolleri (Grid Pattern) */
    body {
        background-image: 
            radial-gradient(circle, rgba(0, 51, 102, 0.03) 1px, transparent 1px),
            radial-gradient(circle, rgba(0, 51, 102, 0.03) 1px, transparent 1px);
        background-size: 40px 40px;
        background-position: 0 0, 20px 20px;
    }

    /* Takvim Kartƒ± ve Konteynƒ±rƒ± */
    .calendar-card {
        border: none;
        border-radius: 20px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        box-shadow: 0 10px 40px rgba(0, 51, 102, 0.1) !important;
    }

    #calendar {
        min-height: 800px;
        padding: 15px;
        font-family: 'Inter', sans-serif;
    }

    /* H√ºcre ƒ∞√ßi Etkinlik Tasarƒ±mƒ± (Ta≈ümayƒ± √ñnleyen) */
    .fc-event {
        cursor: pointer;
        border: none !important;
        border-radius: 6px !important;
        margin-bottom: 2px !important;
        transition: all 0.2s ease;
        border-left: 4px solid var(--btu-accent) !important;
        background-color: rgba(0, 86, 179, 0.1) !important;
    }

    .fc-event:hover {
        transform: scale(1.02);
        z-index: 5;
    }

    .custom-event-node {
        display: flex;
        align-items: center;
        gap: 5px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: 0.8rem;
        padding: 2px 4px;
        color: var(--btu-blue);
    }

    /* Buton ve Ba≈ülƒ±k Modernizasyonu */
    .fc-toolbar-title { color: var(--btu-blue); font-weight: 800 !important; }
    .fc-button-primary {
        background-color: var(--btu-blue) !important;
        border: none !important;
        border-radius: 8px !important;
        font-weight: 600 !important;
    }
    .fc-button-primary:hover { background-color: var(--btu-accent) !important; }

    .fc-day-today { background-color: rgba(0, 168, 204, 0.05) !important; }

    /* MOBƒ∞L RESPONSIVE */
    @media (max-width: 992px) {
        .container-fluid { padding-left: 12px; padding-right: 12px; }
        #calendar { min-height: 600px; padding: 10px; }
        h2 { font-size: 1.3rem; }
        .breadcrumb { font-size: 0.8rem; }
    }

    @media (max-width: 768px) {
        .container-fluid { padding-left: 8px; padding-right: 8px; }
        .row.mb-4 { gap: 1rem; }
        .col-md-8, .col-md-4 { width: 100%; max-width: 100%; }
        h2 { font-size: 1.15rem; margin-bottom: 0.5rem; }
        #calendar { min-height: 500px; padding: 8px; }
        .card { border-radius: 15px; }
        .fc-toolbar { flex-wrap: wrap; gap: 0.5rem; }
        .fc-toolbar-title { font-size: 1rem; }
        .fc-button { font-size: 0.8rem; padding: 0.4rem 0.8rem !important; }
        .fc-event { font-size: 0.7rem; }
        .breadcrumb.mb-2 { margin-bottom: 0.3rem !important; }
    }

    @media (max-width: 576px) {
        .container-fluid { padding-left: 4px; padding-right: 4px; }
        .d-flex.justify-content-between { flex-direction: column; gap: 0.5rem; }
        .text-md-end { text-align: start !important; }
        h2 { font-size: 1rem; }
        p { font-size: 0.75rem; padding-left: 0 !important; }
        .breadcrumb { font-size: 0.7rem; }
        .btn { font-size: 0.75rem; padding: 0.4rem 0.8rem; }
        .card { border-radius: 12px; padding: 0.3rem 0 !important; }
        #calendar { min-height: 400px; padding: 4px; }
        .fc-toolbar { flex-direction: column; }
        .fc-toolbar-title { font-size: 0.9rem; margin-bottom: 0.5rem; }
        .fc-button { font-size: 0.7rem; padding: 0.35rem 0.6rem !important; }
        .fc-event { font-size: 0.65rem; padding: 1px 2px !important; }
        .custom-event-node { font-size: 0.6rem; }
    }

    @media (max-width: 360px) {
        .fc-toolbar-title { font-size: 0.8rem; }
        .fc-button { font-size: 0.6rem; }
        #calendar { min-height: 350px; }
    }
</style>

<div class="container-fluid mt-2 mb-5 px-lg-5">
    <div class="row mb-4 align-items-center">
        <div class="col-md-8">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-1">
                    <li class="breadcrumb-item"><a href="{% url 'anasayfa' %}" class="text-decoration-none">Ana Sayfa</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'lab_detay' lab.id %}" class="text-decoration-none">{{ lab.isim }}</a></li>
                    <li class="breadcrumb-item active">Takvim</li>
                </ol>
            </nav>
            <h2 class="fw-bold text-primary mb-0">
                <i class="bi bi-calendar3 me-2 text-info"></i>{{ lab.isim }} <span class="fw-light text-muted">| Program</span>
            </h2>
            <p class="text-muted small mb-0">Laboratuvar doluluƒüunu inceleyin veya bo≈ü bir g√ºne tƒ±klayarak randevu olu≈üturun.</p>
        </div>
        <div class="col-md-4 text-md-end">
            <a href="{% url 'lab_detay' lab.id %}" class="btn btn-outline-primary rounded-pill px-4">
                <i class="bi bi-arrow-left me-2"></i>Cihaz Listesine D√∂n
            </a>
        </div>
    </div>

    <div class="card calendar-card">
        <div class="card-body">
            <div id='calendar'></div>
        </div>
    </div>
</div>

{{ cihazlar_json|json_script:"cihaz-data" }}

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendar');
        var devices = JSON.parse(document.getElementById('cihaz-data').textContent);

        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'tr',
            firstDay: 1,
            dayMaxEvents: 4, 
            displayEventTime: false, // H√ºcre ta≈ümasƒ±nƒ± engelleyen kritik ayar
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            buttonText: { today: 'Bug√ºn', month: 'Ay', week: 'Hafta', day: 'G√ºn' },
            events: '/api/lab/{{ lab.id }}/events/',
            selectable: true,

            // ƒ∞kon Entegrasyonu ve Temiz G√∂r√ºn√ºm
            eventContent: function(arg) {
                let icon = "‚ö™";
                let status = arg.event.extendedProps.durum || "";
                if (status.includes("Onaylandƒ±")) icon = "‚úÖ";
                else if (status.includes("Bekliyor")) icon = "‚è≥";
                else if (status.includes("Geldi")) icon = "üü¶";
                else if (status.includes("Gelmedi")) icon = "üü•";
                else icon = "‚ùå";

                let container = document.createElement('div');
                container.className = 'custom-event-node';
                container.innerHTML = `<span>${icon}</span><span class="fw-bold">${arg.event.title}</span>`;
                return { domNodes: [container] };
            },

            // Bo≈ü Alan Se√ßimi (Hƒ±zlƒ± Randevu)
            select: function(info) {
                var modal = new bootstrap.Modal(document.getElementById('selectModal'));
                var deviceOptions = devices.map(d => `<option value="${d.id}">${d.isim}</option>`).join('');
                document.getElementById('selectDevice').innerHTML = deviceOptions;
                document.getElementById('selectDate').value = info.startStr;
                modal.show();
            },

            // Etkinlik Tƒ±klama (Detay Modalƒ±)
            eventClick: function(info) {
                var props = info.event.extendedProps;
                let startTime = info.event.start.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
                let endTime = info.event.end ? info.event.end.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }) : '';

                document.getElementById('mcTitle').innerText = info.event.title;
                document.getElementById('mcSaat').innerText = `${startTime} - ${endTime}`;
                document.getElementById('mcKullanici').innerText = props.kullanici;
                document.getElementById('mcDurum').innerText = props.durum;
                
                var durumBadge = document.getElementById('mcDurum');
                durumBadge.className = 'badge rounded-pill px-3 py-2'; 
                if(props.durum.includes('Onaylandƒ±') || props.durum.includes('Geldi')) durumBadge.classList.add('bg-success');
                else if(props.durum.includes('Bekliyor')) durumBadge.classList.add('bg-warning', 'text-dark');
                else durumBadge.classList.add('bg-danger');

                new bootstrap.Modal(document.getElementById('eventModal')).show();
            }
        });

        calendar.render();
    });

    function randevuyaGit() {
        var devId = document.getElementById('selectDevice').value;
        var date = document.getElementById('selectDate').value;
        if (!devId) { alert("L√ºtfen bir cihaz se√ßin!"); return; }
        window.location.href = `/cihaz/${devId}/?tarih=${date}`;
    }
</script>

<div class="modal fade" id="selectModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header bg-primary text-white py-3">
                <h5 class="modal-title fw-bold"><i class="bi bi-plus-circle me-2"></i>Yeni Randevu</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4 text-start">
                <div class="mb-3 text-start">
                    <label class="form-label fw-bold">Cihaz Se√ßimi</label>
                    <select id="selectDevice" class="form-select border-2"></select>
                </div>
                <div class="mb-2">
                    <label class="form-label fw-bold text-muted small">Tarih</label>
                    <input id="selectDate" class="form-control bg-light border-0" readonly>
                </div>
            </div>
            <div class="modal-footer border-0 p-4 pt-0">
                <button onclick="randevuyaGit()" class="btn btn-primary btn-lg w-100 rounded-pill fw-bold">Randevuya Git</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">
            <div class="modal-header bg-light border-0 py-3">
                <h5 class="modal-title fw-bold text-primary" id="mcTitle">Cihaz Bilgisi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0 text-center">
                <div class="py-4 bg-primary-subtle border-bottom border-white border-4">
                    <h2 id="mcSaat" class="fw-bold text-primary mb-0"></h2>
                    <small class="text-muted">Laboratuvar Kullanƒ±m Saati</small>
                </div>
                <div class="list-group list-group-flush text-start">
                    <div class="list-group-item d-flex justify-content-between py-3 border-0">
                        <span class="text-muted"><i class="bi bi-person me-2"></i>Kullanƒ±cƒ±:</span>
                        <span id="mcKullanici" class="fw-bold text-dark"></span>
                    </div>
                    <div class="list-group-item d-flex justify-content-between py-3 border-0 align-items-center">
                        <span class="text-muted"><i class="bi bi-info-circle me-2"></i>Durum:</span>
                        <span id="mcDurum"></span>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 p-3">
                <button type="button" class="btn btn-secondary w-100 rounded-pill" data-bs-dismiss="modal">Kapat</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}