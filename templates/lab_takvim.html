{% extends 'base.html' %}

{% block icerik %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold" style="color: #444;">ðŸ“… {{ lab.isim }} Takvimi</h2>
            <p class="text-muted">Laboratuvar doluluk durumunu gÃ¶rÃ¼ntÃ¼leyin veya boÅŸ bir alana tÄ±klayarak randevu oluÅŸturun.</p>
        </div>
        <div>
            <a href="{% url 'lab_detay' lab.id %}" class="btn btn-outline-dark">
                <i class="fas fa-arrow-left"></i> Cihaz Listesine DÃ¶n
            </a>
        </div>
    </div>

    <div class="card shadow-sm border-0" style="border-radius: 15px;">
        <div class="card-body p-4">
            <div id='calendar'></div>
        </div>
    </div>
</div>

<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>

<style>
    /* E-KampÃ¼s TarzÄ± TasarÄ±m */
    #calendar {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        min-height: 800px;
    }
    .fc-col-header-cell {
        background-color: #f8f9fa;
        padding: 10px 0;
    }
    .fc-day-today {
        background-color: #e8f4ff !important; /* BugÃ¼nÃ¼n rengi */
    }
    .fc-event {
        cursor: pointer;
        border: none;
        padding: 2px 5px;
        font-size: 0.85rem;
    }
</style>
{{ cihazlar_json|json_script:"cihaz-data" }}

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendar');
        var devices = JSON.parse(document.getElementById('cihaz-data').textContent);

        var calendar = new FullCalendar.Calendar(calendarEl, {
            // BURAYI DEÄžÄ°ÅžTÄ°RDÄ°K: E-KampÃ¼s gibi AylÄ±k GÃ¶rÃ¼nÃ¼m
            initialView: 'dayGridMonth', 
            locale: 'tr',
            firstDay: 1, // Pazartesi ile baÅŸla
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay' // GÃ¶rÃ¼nÃ¼m deÄŸiÅŸtirme butonlarÄ±
            },
            buttonText: {
                today: 'BugÃ¼n',
                month: 'Ay',
                week: 'Hafta',
                day: 'GÃ¼n'
            },

            // API'den veri Ã§ekme
            events: '/api/lab/{{ lab.id }}/events/',

            selectable: true, // TÄ±klanabilir yap

            // BoÅŸ yere tÄ±klayÄ±nca (Yeni Randevu)
            select: function(info) {
                var modal = new bootstrap.Modal(document.getElementById('selectModal'));
                
                // CihazlarÄ± listeye doldur
                var deviceOptions = devices.map(d => `<option value="${d.id}">${d.isim}</option>`).join('');
                document.getElementById('selectDevice').innerHTML = deviceOptions;

                // Tarihleri doldur
                document.getElementById('selectDate').value = info.startStr;
                
                modal.show();
            },

            // Dolu etkinliÄŸe tÄ±klayÄ±nca (Detay GÃ¶r)
            eventClick: function(info) {
                var props = info.event.extendedProps;
                document.getElementById('mcTitle').innerText = info.event.title;
                document.getElementById('mcCihaz').innerText = props.cihaz_id;
                document.getElementById('mcKullanici').innerText = props.kullanici;
                document.getElementById('mcDurum').innerText = props.durum;
                
                var detayModal = new bootstrap.Modal(document.getElementById('eventModal'));
                detayModal.show();
            }
        });

        calendar.render();
    });

    // Modal iÃ§indeki "Rezerve Et" butonu
    function randevuyaGit() {
        var devId = document.getElementById('selectDevice').value;
        var date = document.getElementById('selectDate').value;
        // SeÃ§ilen bilgilerle randevu sayfasÄ±na yÃ¶nlendir
        window.location.href = `/cihaz/${devId}/?tarih=${date}`;
    }
</script>

<div class="modal fade" id="eventModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-light">
        <h5 class="modal-title" id="mcTitle">Randevu DetayÄ±</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p><strong>Cihaz:</strong> <span id="mcCihaz"></span></p>
        <p><strong>KullanÄ±cÄ±:</strong> <span id="mcKullanici"></span></p>
        <p><strong>Durum:</strong> <span id="mcDurum" class="badge bg-secondary"></span></p>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="selectModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Yeni Randevu OluÅŸtur</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <label>Hangi cihaz iÃ§in?</label>
        <select id="selectDevice" class="form-select mb-3"></select>
        
        <label>Tarih</label>
        <input id="selectDate" class="form-control" readonly>
      </div>
      <div class="modal-footer">
        <button onclick="randevuyaGit()" class="btn btn-success w-100">Randevu EkranÄ±na Git</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}